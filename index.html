<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopManage - Product Management System</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Theme Variables - Light Mode Default */
            --bg-body: #f8f9fa;
            --bg-surface: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --input-bg: #ffffff;
            --card-shadow: 0 10px 20px rgba(0,0,0,0.05);
            --hover-shadow: 0 15px 30px rgba(0,0,0,0.1);

            /* Gradients remain constant */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #2af598 0%, #009efd 100%);
        }

        /* Dark Mode Overrides */
        body.dark-mode {
            --bg-body: #0f172a;
            --bg-surface: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --input-bg: #0f172a;
            --card-shadow: 0 10px 20px rgba(0,0,0,0.3);
            --hover-shadow: 0 15px 30px rgba(0,0,0,0.4);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Navigation */
        .modern-nav {
            background: var(--bg-surface);
            box-shadow: 0 2px 15px rgba(0,0,0,0.04);
            padding: 1rem 0;
            transition: background-color 0.3s;
        }

        .brand-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            color: var(--text-primary) !important;
            text-decoration: none;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .nav-link {
            color: var(--text-secondary) !important;
            font-weight: 500;
            transition: color 0.3s;
            cursor: pointer;
        }

        .nav-link.active, .nav-link:hover {
            color: #764ba2 !important;
        }

        /* Theme Toggle Button */
        .theme-toggle-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .theme-toggle-btn:hover {
            background: var(--bg-body);
            transform: rotate(15deg);
        }

        /* Buttons */
        .btn-gradient-primary {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-gradient-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.3);
            color: white;
        }

        .btn-modern-outline {
            border: 1px solid var(--border-color);
            background: var(--bg-surface);
            color: var(--text-secondary);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            transition: all 0.2s;
        }

        .btn-modern-outline:hover {
            border-color: #cbd5e1;
            background: var(--bg-body);
            color: var(--text-primary);
        }

        /* Search */
        .search-wrapper {
            position: relative;
        }

        .search-input {
            border: 1px solid var(--border-color);
            border-radius: 50px;
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            width: 250px;
            transition: all 0.3s;
            outline: none;
            background-color: var(--bg-surface);
            color: var(--text-primary);
        }

        .search-input:focus {
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Cards & Stats */
        .page-header-card {
            background: var(--bg-surface);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .modern-stats-card {
            background: var(--bg-surface);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            height: 100%;
            border: 1px solid var(--border-color);
            transition: transform 0.3s;
        }

        .modern-stats-card:hover {
            transform: translateY(-5px);
        }

        .stats-content {
            position: relative;
            z-index: 2;
        }

        .stats-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stats-bg-icon {
            position: absolute;
            right: -20px;
            bottom: -20px;
            font-size: 8rem;
            opacity: 0.05;
            transform: rotate(-15deg);
            z-index: 1;
        }

        /* Gradient Accents for Stats */
        .gradient-blue .stats-icon { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .gradient-green .stats-icon { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .gradient-orange .stats-icon { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .gradient-red .stats-icon { background: rgba(239, 68, 68, 0.1); color: #ef4444; }

        .stats-value { font-size: 2rem; font-weight: 700; color: var(--text-primary); margin: 0; }
        .stats-label { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.25rem; }

        /* Product Cards */
        .product-card {
            background: var(--bg-surface);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: all 0.3s;
            height: 100%;
            position: relative;
            border: 1px solid var(--border-color);
        }

        .product-card:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-5px);
        }

        .product-img-wrapper {
            height: 200px;
            background: var(--bg-body);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }
        
        .product-card:hover .product-img {
            transform: scale(1.05);
        }

        .card-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s;
        }

        .product-card:hover .card-actions {
            opacity: 1;
            transform: translateY(0);
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: var(--bg-surface);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: var(--text-secondary);
            transition: all 0.2s;
            cursor: pointer;
        }
        .action-btn.edit:hover { background: #3b82f6; color: white; }
        .action-btn.delete:hover { background: #ef4444; color: white; }
        .action-btn.sell:hover { background: #10b981; color: white; }

        .product-details { padding: 1.5rem; }
        .product-category { font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.5px; font-weight: 600; margin-bottom: 0.5rem; display: block; }
        .product-title { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .product-price { font-size: 1.25rem; font-weight: 700; color: #764ba2; }
        .product-price-sale { font-size: 1.25rem; font-weight: 700; color: #ef4444; }
        
        .stock-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .bg-stock-green { background: #dcfce7; color: #166534; }
        .bg-stock-orange { background: #ffedd5; color: #9a3412; }
        .bg-stock-red { background: #fee2e2; color: #991b1b; }

        /* Modal Styles */
        .modern-modal .modal-content { border-radius: 20px; border: none; overflow: hidden; background-color: var(--bg-surface); }
        .modern-modal-header { background: var(--primary-gradient); color: white; border: none; padding: 1.5rem; }
        .modern-modal-body { padding: 2rem; color: var(--text-primary); }
        
        .form-control-modern, .form-select-modern {
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: all 0.3s;
            background-color: var(--input-bg);
            color: var(--text-primary);
        }
        .form-control-modern:focus, .form-select-modern:focus { 
            border-color: #764ba2; 
            box-shadow: 0 0 0 4px rgba(118, 75, 162, 0.1); 
            outline: none; 
            background-color: var(--input-bg);
            color: var(--text-primary);
        }
        .form-control-modern[readonly] {
            background-color: var(--bg-body);
            color: var(--text-secondary);
            font-weight: 700;
        }
        
        .image-preview-card { border: 2px dashed var(--border-color); border-radius: 12px; padding: 1rem; text-align: center; margin-top: 10px; }
        .preview-image { max-height: 200px; max-width: 100%; border-radius: 8px; object-fit: contain; }

        /* Table View */
        .modern-table { color: var(--text-primary); }
        .modern-table thead th { 
            background: var(--bg-body); 
            color: var(--text-secondary); 
            font-weight: 600; 
            border-bottom: 2px solid var(--border-color); 
            padding: 1rem; 
            text-transform: uppercase; 
            font-size: 0.75rem; 
            letter-spacing: 0.05em; 
        }
        .modern-table td { padding: 1rem; vertical-align: middle; border-bottom: 1px solid var(--border-color); }
        .table-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
        .table-hover tbody tr:hover { background-color: var(--bg-body); color: var(--text-primary); }
        
        /* Catalog Card */
        .catalog-card { background: var(--bg-surface); border-radius: 16px; border: none; box-shadow: var(--card-shadow); }
        .catalog-header { background: var(--bg-surface); color: var(--text-primary); border-bottom: 1px solid var(--border-color); }
        
        /* Toast Notifications */
        .toast-container-custom {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1060;
        }
        .custom-toast {
            background: var(--bg-surface);
            color: var(--text-primary);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border-left: 5px solid transparent;
            min-width: 320px;
            border: 1px solid var(--border-color);
            border-left-width: 5px;
        }
        .custom-toast.show {
            transform: translateX(0);
        }
        .custom-toast.success { border-left-color: #10b981; }
        .custom-toast.error { border-left-color: #ef4444; }

        /* Pagination Styles */
        .page-link {
            color: var(--text-primary);
            background-color: var(--bg-surface);
            border-color: var(--border-color);
            transition: all 0.2s;
            cursor: pointer;
        }
        .page-link:hover {
            color: #764ba2;
            background-color: var(--bg-body);
            border-color: #cbd5e1;
        }
        .page-item.active .page-link {
            background: var(--primary-gradient);
            border-color: transparent;
            color: white;
        }
        .page-item.disabled .page-link {
            background-color: var(--bg-body);
            border-color: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        /* Table Row Alerts */
        .modern-table tr.row-low-stock {
            background-color: rgba(245, 158, 11, 0.15); /* Orange tint for Low Stock */
        }
        .modern-table tr.row-out-stock {
            background-color: rgba(239, 68, 68, 0.15); /* Red tint for Out of Stock */
        }
        /* Ensure hover still works comfortably */
        .modern-table tr.row-low-stock:hover {
            background-color: rgba(245, 158, 11, 0.25) !important;
        }
        .modern-table tr.row-out-stock:hover {
            background-color: rgba(239, 68, 68, 0.25) !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark modern-nav">
        <div class="container">
            <a href="#" class="navbar-brand brand-logo">
                <div class="logo-icon">
                    <i class="bi bi-shop"></i>
                </div>
                <span class="brand-text">ShopManage</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon" style="filter: invert(0.5);"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto me-4">
                    <li class="nav-item">
                        <a class="nav-link active" id="navInventory" onclick="switchView('inventory')">
                            <i class="bi bi-grid me-1"></i>Inventory
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="navSales" onclick="switchView('sales')">
                            <i class="bi bi-receipt me-1"></i>Sales History
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="navReports" onclick="switchView('inventory'); location.href='#analyticsSection'">
                            <i class="bi bi-graph-up me-1"></i>Reports
                        </a>
                    </li>
                </ul>
                <div class="d-flex align-items-center gap-3 flex-wrap">
                    <!-- Theme Toggle Button -->
                    <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
                        <i class="bi bi-moon-fill" id="themeIcon"></i>
                    </button>

                    <button class="btn btn-gradient-primary px-4" type="button" onclick="openAddModal()">
                        <i class="bi bi-plus-circle me-2"></i>Add Product
                    </button>
                    <form class="search-form" onsubmit="return false;">
                        <div class="search-wrapper">
                            <i class="bi bi-search search-icon"></i>
                            <input class="search-input" id="searchInput" type="search" placeholder="Search products..." aria-label="Search">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container main-container mt-4">
        
        <!-- INVENTORY VIEW -->
        <div id="inventoryView">
            <!-- Page Header -->
            <header class="row mb-4">
                <div class="col-12">
                    <div class="page-header-card">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <div>
                                <h1 class="h3 mb-2 fw-bold">Inventory Management</h1>
                                <p class="mb-0" style="color: var(--text-secondary)"><i class="bi bi-layers me-2"></i>Manage your inventory and product catalog</p>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Product Statistics -->
            <section class="row stats-section mb-4">
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="modern-stats-card gradient-blue">
                        <div class="stats-content">
                            <div class="stats-icon"><i class="bi bi-box-seam"></i></div>
                            <div class="stats-info">
                                <h5 class="stats-label">Total Products</h5>
                                <p class="stats-value" id="totalProducts">0</p>
                            </div>
                        </div>
                        <div class="stats-bg-icon"><i class="bi bi-box-seam"></i></div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="modern-stats-card gradient-green">
                        <div class="stats-content">
                            <div class="stats-icon"><i class="bi bi-check-circle"></i></div>
                            <div class="stats-info">
                                <h5 class="stats-label">In Stock</h5>
                                <p class="stats-value" id="inStock">0</p>
                            </div>
                        </div>
                        <div class="stats-bg-icon"><i class="bi bi-check-circle"></i></div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="modern-stats-card gradient-orange">
                        <div class="stats-content">
                            <div class="stats-icon"><i class="bi bi-exclamation-triangle"></i></div>
                            <div class="stats-info">
                                <h5 class="stats-label">Low Stock</h5>
                                <p class="stats-value" id="lowStock">0</p>
                            </div>
                        </div>
                        <div class="stats-bg-icon"><i class="bi bi-exclamation-triangle"></i></div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="modern-stats-card gradient-red">
                        <div class="stats-content">
                            <div class="stats-icon"><i class="bi bi-x-circle"></i></div>
                            <div class="stats-info">
                                <h5 class="stats-label">Out of Stock</h5>
                                <p class="stats-value" id="outOfStock">0</p>
                            </div>
                        </div>
                        <div class="stats-bg-icon"><i class="bi bi-x-circle"></i></div>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section class="row mb-4" id="analyticsSection">
                <div class="col-12">
                    <div class="card catalog-card">
                        <div class="card-header catalog-header p-4 border-bottom-0">
                            <h5 class="mb-0 fw-bold"><i class="bi bi-pie-chart me-2"></i>Analytics Dashboard</h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="row align-items-center">
                                <div class="col-md-6 mb-4 mb-md-0">
                                    <h6 class="fw-bold text-center mb-3" style="color: var(--text-secondary);">Product Distribution by Category</h6>
                                    <div style="height: 300px; position: relative;">
                                        <canvas id="categoryChart"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-6 text-center">
                                    <div class="p-4 rounded-3" style="background-color: var(--bg-body); border: 1px solid var(--border-color);">
                                        <h6 class="fw-bold mb-3" style="color: var(--text-secondary);">Inventory Summary</h6>
                                        <div class="row text-center g-3">
                                            <div class="col-6">
                                                <h2 class="fw-bold mb-0" style="color: #764ba2;" id="totalStockValue">0</h2>
                                                <small class="text-muted">Total Categories</small>
                                            </div>
                                            <div class="col-6">
                                                <h2 class="fw-bold mb-0" style="color: #10b981;" id="mostStocked">0</h2>
                                                <small class="text-muted">Top Category</small>
                                            </div>
                                        </div>
                                        <p class="mt-4 text-muted small">
                                            <i class="bi bi-info-circle me-1"></i>
                                            This chart visualizes the distribution of your inventory across different categories.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Product Listing -->
            <section class="row" id="productList">
                <div class="col-12">
                    <div class="card catalog-card">
                        <div class="card-header catalog-header p-4 border-bottom-0 d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <h5 class="mb-0 fw-bold"><i class="bi bi-grid-3x3-gap me-2"></i>Product Catalog</h5>
                            
                            <div class="d-flex align-items-center gap-2">
                                <!-- Export Button -->
                                <button class="btn btn-modern-outline btn-sm" onclick="exportToCSV()" title="Download as CSV">
                                    <i class="bi bi-download me-1"></i> <span class="d-none d-sm-inline">Export</span>
                                </button>

                                <!-- Sort Dropdown -->
                                <select class="form-select-modern py-1" id="sortSelect" style="min-width: 150px; font-size: 0.9rem;">
                                    <option value="name_asc">Name (A-Z)</option>
                                    <option value="price_asc">Price (Low to High)</option>
                                    <option value="price_desc">Price (High to Low)</option>
                                </select>

                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="viewToggle" id="cardView" checked autocomplete="off">
                                    <label class="btn btn-outline-secondary btn-sm" for="cardView"><i class="bi bi-grid-3x3-gap"></i></label>
                                    <input type="radio" class="btn-check" name="viewToggle" id="tableView" autocomplete="off">
                                    <label class="btn btn-outline-secondary btn-sm" for="tableView"><i class="bi bi-table"></i></label>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <!-- Loading -->
                            <div id="loadingSpinner" class="text-center py-5 d-none">
                                <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                            </div>

                            <!-- Card Grid -->
                            <div id="cardContainer" class="row g-4"></div>

                            <!-- Table View -->
                            <div id="tableContainer" class="d-none">
                                <div class="table-responsive">
                                    <table class="table modern-table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Image</th>
                                                <th>Product</th>
                                                <th>Category</th>
                                                <th>Price</th>
                                                <th>Stock</th>
                                                <th class="text-end">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="productTableBody"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div id="emptyState" class="text-center py-5 d-none">
                                <div class="mb-3 text-muted" style="font-size: 3rem;"><i class="bi bi-inbox"></i></div>
                                <h4>No Products Found</h4>
                                <p class="text-muted">Start by adding your first product.</p>
                            </div>

                            <!-- Pagination -->
                            <div id="paginationContainer" class="mt-4 pt-3 border-top" style="border-color: var(--border-color) !important;">
                                <nav aria-label="Product pagination">
                                    <ul class="pagination justify-content-center mb-0" id="paginationControls">
                                        <!-- Pagination items will be injected here -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- SALES HISTORY VIEW -->
        <div id="salesView" class="d-none">
            <!-- Header -->
            <header class="row mb-4">
                <div class="col-12">
                    <div class="page-header-card">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <div>
                                <h1 class="h3 mb-2 fw-bold">Sales History</h1>
                                <p class="mb-0" style="color: var(--text-secondary)"><i class="bi bi-clock-history me-2"></i>Track your sales transactions</p>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Sales Summary -->
            <section class="row mb-4">
                <div class="col-md-6 mb-3">
                    <div class="modern-stats-card gradient-green">
                        <div class="stats-content">
                            <div class="stats-icon"><i class="bi bi-cash-coin"></i></div>
                            <div class="stats-info">
                                <h5 class="stats-label">Total Revenue</h5>
                                <p class="stats-value" id="totalRevenue">$0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="modern-stats-card gradient-blue">
                        <div class="stats-content">
                            <div class="stats-icon"><i class="bi bi-cart-check"></i></div>
                            <div class="stats-info">
                                <h5 class="stats-label">Items Sold</h5>
                                <p class="stats-value" id="totalItemsSold">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sales Table -->
            <section class="row">
                <div class="col-12">
                    <div class="card catalog-card">
                        <div class="card-header catalog-header p-4 border-bottom-0">
                            <h5 class="mb-0 fw-bold"><i class="bi bi-list-ul me-2"></i>Transaction Log</h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="table-responsive">
                                <table class="table modern-table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Product</th>
                                            <th>SKU</th>
                                            <th>Quantity</th>
                                            <th>Total Price</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salesTableBody">
                                        <!-- Sales populated here -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="salesEmptyState" class="text-center py-5 d-none">
                                <div class="mb-3 text-muted" style="font-size: 2rem;"><i class="bi bi-receipt"></i></div>
                                <h5>No Sales Yet</h5>
                                <p class="text-muted">Sell items from the inventory to see records here.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

    </main>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container-custom"></div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modern-modal">
                <div class="modal-body text-center p-4">
                    <div class="mb-3 text-danger" style="font-size: 3rem;">
                        <i class="bi bi-exclamation-circle"></i>
                    </div>
                    <h5 class="mb-2 fw-bold">Delete Product?</h5>
                    <p style="color: var(--text-secondary)" class="mb-4">Are you sure you want to delete this product? This action cannot be undone.</p>
                    <div class="d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-modern-outline" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sell Product Modal -->
    <div class="modal fade" id="sellModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modern-modal">
                <div class="modal-header modern-modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-cart-check me-2"></i>Sell Product</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body modern-modal-body">
                    <form id="sellForm">
                        <input type="hidden" id="sellProductId">
                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small text-uppercase">Product</label>
                            <div class="fw-bold fs-5" id="sellProductName">Product Name</div>
                            <div class="text-muted" id="sellProductSku">SKU: 12345</div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label fw-bold text-muted small">Current Stock</label>
                                <div class="fs-5" id="sellCurrentStock">0</div>
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold text-muted small">Unit Price</label>
                                <div class="fs-5 text-primary" id="sellUnitPrice">$0.00</div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Quantity to Sell</label>
                            <input type="number" class="form-control form-control-modern" id="sellQuantity" min="1" value="1" required>
                            <div class="form-text text-danger d-none" id="sellStockError">Not enough stock available.</div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center p-3 rounded" style="background-color: var(--bg-body);">
                            <span class="fw-bold">Total Amount:</span>
                            <span class="fs-4 fw-bold text-success" id="sellTotal">$0.00</span>
                        </div>

                        <div class="mt-4 text-end">
                            <button type="button" class="btn btn-modern-outline me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success fw-bold px-4">Complete Sale</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content modern-modal">
                <div class="modal-header modern-modal-header">
                    <h5 class="modal-title" id="productModalLabel">Add New Product</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body modern-modal-body">
                    <form id="productForm">
                        <!-- Hidden Input for ID -->
                        <input type="hidden" id="editProductId" value="">
                        
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-bold">Product Title</label>
                                <input type="text" class="form-control form-control-modern" id="productTitle" required>
                            </div>
                            
                            <!-- Price, Sale Price, Discount Row -->
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Price</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0" style="background-color: var(--border-color) !important; color: var(--text-primary);">$</span>
                                    <input type="number" class="form-control form-control-modern" id="productPrice" step="0.01" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Sale Price</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0" style="background-color: var(--border-color) !important; color: var(--text-primary);">$</span>
                                    <input type="number" class="form-control form-control-modern" id="productSalePrice" step="0.01" min="0" placeholder="Optional">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Discount %</label>
                                <input type="text" class="form-control form-control-modern" id="productDiscount" readonly placeholder="Auto">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Category</label>
                                <select class="form-select form-control-modern" id="productCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="Electronics">Electronics</option>
                                    <option value="Clothing">Clothing</option>
                                    <option value="Books">Books</option>
                                    <option value="Home">Home & Garden</option>
                                    <option value="Beauty">Beauty & Health</option>
                                    <option value="Sports">Sports & Outdoors</option>
                                    <option value="Accessories">Accessories</option>
                                </select>
                            </div>
                            
                            <!-- Brand -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Brand</label>
                                <input type="text" class="form-control form-control-modern" id="productBrand" placeholder="e.g. Sony, Nike">
                            </div>

                            <!-- Supplier -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Supplier Name</label>
                                <input type="text" class="form-control form-control-modern" id="productSupplier" placeholder="e.g. TechDistro Inc.">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Stock Quantity</label>
                                <input type="number" class="form-control form-control-modern" id="productStock" min="0" required>
                            </div>

                            <!-- Product Description -->
                            <div class="col-12">
                                <label class="form-label fw-bold">Product Description</label>
                                <textarea class="form-control form-control-modern" id="productDescription" rows="3" placeholder="Enter detailed product description..."></textarea>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Image URL</label>
                                <input type="url" class="form-control form-control-modern" id="productImage" placeholder="https://">
                            </div>
                            <!-- Image Preview -->
                            <div class="col-12 d-none" id="imagePreviewContainer">
                                <div class="image-preview-card">
                                    <img id="imagePreview" src="" alt="Preview" class="preview-image">
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label fw-bold">SKU</label>
                                <input type="text" class="form-control form-control-modern" id="productSku" placeholder="Auto-generated if empty">
                            </div>
                        </div>
                        <div class="mt-4 text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-gradient-primary">Save Product</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- SAFE DEFAULT DATA ---
        const defaultData = [
            {
                id: 1,
                title: "Wireless Headphones",
                price: "99.99",
                salePrice: "79.99",
                category: "Electronics",
                brand: "SoundMax",
                supplier: "Audio Imports Ltd",
                description: "High-fidelity wireless headphones with active noise cancellation and 20-hour battery life.",
                image: "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=500&q=80",
                stock: 15,
                sku: "AUDIO-001"
            },
            {
                id: 2,
                title: "Running Shoes",
                price: "79.50",
                category: "Sports",
                brand: "RunFast",
                supplier: "Sporty Goods Inc",
                description: "Lightweight running shoes designed for marathon distance comfort and durability.",
                image: "https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=500&q=80",
                stock: 5,
                sku: "SPORT-002"
            },
            {
                id: 3,
                title: "Minimalist Watch",
                price: "120.00",
                salePrice: "89.99",
                category: "Clothing",
                brand: "Timeless",
                supplier: "Lux Watch Co",
                description: "A classic analog watch with a genuine leather strap and water resistance up to 50m.",
                image: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=500&q=80",
                stock: 0,
                sku: "TIME-003"
            },
            {
                id: 4,
                title: "Smart Speaker Home",
                price: "49.99",
                category: "Home",
                brand: "ConnectHome",
                supplier: "Smart Living Tech",
                description: "Voice-controlled smart speaker that connects to your home automation system.",
                image: "https://images.unsplash.com/photo-1589492477829-5e65395b66cc?w=500&q=80",
                stock: 22,
                sku: "HOME-004"
            },
            {
                id: 5,
                title: "Premium Yoga Mat",
                price: "29.95",
                salePrice: "24.95",
                category: "Sports",
                brand: "ZenFlex",
                supplier: "Wellness Supply",
                description: "Non-slip, eco-friendly yoga mat perfect for all types of yoga and pilates.",
                image: "https://images.unsplash.com/photo-1601925260368-ae2f83cf8b7f?w=500&q=80",
                stock: 8,
                sku: "YOGA-005"
            },
            {
                id: 6,
                title: "Ceramic Coffee Set",
                price: "65.00",
                category: "Home",
                brand: "ArtisanCraft",
                supplier: "Home Decor Imports",
                description: "Handcrafted ceramic coffee set including 4 mugs and a serving pot.",
                image: "https://images.unsplash.com/photo-1567748154382-72352885971a?w=500&q=80",
                stock: 12,
                sku: "COFFEE-006"
            },
            {
                id: 7,
                title: "Gaming Mouse RGB",
                price: "45.00",
                salePrice: "29.99",
                category: "Electronics",
                brand: "ProGamer",
                supplier: "TechWorld Distributors",
                description: "Ergonomic gaming mouse with customizable RGB lighting and programmable buttons.",
                image: "https://images.unsplash.com/photo-1527814050087-3793815479db?w=500&q=80",
                stock: 4,
                sku: "GAME-007"
            },
            {
                id: 8,
                title: "Organic Face Oil",
                price: "32.00",
                category: "Beauty",
                brand: "PureGlow",
                supplier: "Nature's Best",
                description: "100% organic cold-pressed face oil rich in antioxidants and vitamins.",
                image: "https://images.unsplash.com/photo-1608248597279-f99d160bfbc8?w=500&q=80",
                stock: 25,
                sku: "BEAUTY-008"
            },
            {
                id: 9,
                title: "Bluetooth Fitness Tracker",
                price: "55.00",
                category: "Electronics",
                brand: "ActiveLife",
                supplier: "Gadget Central",
                description: "Track your steps, heart rate, and sleep with this waterproof fitness tracker.",
                image: "https://images.unsplash.com/photo-1576243345690-4e4b79b63288?w=500&q=80",
                stock: 18,
                sku: "FIT-009"
            },
            {
                id: 10,
                title: "Leather Office Backpack",
                price: "110.00",
                salePrice: "95.00",
                category: "Accessories",
                brand: "UrbanCarry",
                supplier: "LeatherWorks Co",
                description: "Stylish and durable leather backpack with a dedicated laptop compartment.",
                image: "https://images.unsplash.com/photo-1548036328-c9fa89d128fa?w=500&q=80",
                stock: 9,
                sku: "BAG-010"
            },
            {
                id: 11,
                title: "Mechanical Keyboard",
                price: "89.99",
                category: "Electronics",
                brand: "ClickMaster",
                supplier: "TechWorld Distributors",
                description: "Compact mechanical keyboard with blue switches for a tactile typing experience.",
                image: "https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=500&q=80",
                stock: 6,
                sku: "KEY-011"
            },
            {
                id: 12,
                title: "Scented Candle Set",
                price: "24.99",
                category: "Home",
                brand: "Lumina",
                supplier: "Home Decor Imports",
                description: "Set of 3 scented candles (Lavender, Vanilla, Sandalwood) made from soy wax.",
                image: "https://images.unsplash.com/photo-1600180758890-6b94519a8ba6?w=500&q=80",
                stock: 20,
                sku: "CANDLE-012"
            },
            {
                id: 13,
                title: "Classic Sunglasses",
                price: "39.00",
                category: "Accessories",
                brand: "SunGuard",
                supplier: "Fashion Eyes",
                description: "UV400 protected sunglasses with a timeless frame design.",
                image: "https://images.unsplash.com/photo-1511499767150-a48a237f0083?w=500&q=80",
                stock: 14,
                sku: "SUN-013"
            },
            {
                id: 14,
                title: "Stainless Steel Water Bottle",
                price: "22.50",
                category: "Sports",
                brand: "HydroKeep",
                supplier: "Sporty Goods Inc",
                description: "Double-walled vacuum insulated water bottle keeps drinks cold for 24 hours.",
                image: "https://images.unsplash.com/photo-1523362628745-0c100150b504?w=500&q=80",
                stock: 30,
                sku: "WATER-014"
            },
            {
                id: 15,
                title: "Desk Plant Decor",
                price: "18.00",
                salePrice: "12.99",
                category: "Home",
                brand: "GreenSpace",
                supplier: "Nature's Best",
                description: "Artificial succulent plant in a modern geometric pot, perfect for desk decor.",
                image: "https://images.unsplash.com/photo-1501004318641-b39e6451bec6?w=500&q=80",
                stock: 17,
                sku: "PLANT-015"
            }
        ];

        let products = [...defaultData];
        let sales = []; 
        const STORAGE_KEY = 'shopManage_products_v7'; 
        const SALES_STORAGE_KEY = 'shopManage_sales_v1';
        
        // --- Pagination State ---
        let currentPage = 1;
        const ITEMS_PER_PAGE = 8; // 8 items per page (2 rows on large screens)

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            loadProducts();
            loadSales();
            setupEventListeners();
        });

        // --- View Switching ---
        function switchView(viewName) {
            const inventoryView = document.getElementById('inventoryView');
            const salesView = document.getElementById('salesView');
            const navInventory = document.getElementById('navInventory');
            const navSales = document.getElementById('navSales');
            const navReports = document.getElementById('navReports');

            navInventory.classList.remove('active');
            navSales.classList.remove('active');
            navReports.classList.remove('active');

            if (viewName === 'inventory') {
                inventoryView.classList.remove('d-none');
                salesView.classList.add('d-none');
                navInventory.classList.add('active');
            } else if (viewName === 'sales') {
                inventoryView.classList.add('d-none');
                salesView.classList.remove('d-none');
                navSales.classList.add('active');
                renderSalesHistory();
            }
        }

        // --- Theme Management ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('themeIcon');
            
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                if(themeIcon) {
                    themeIcon.classList.remove('bi-moon-fill');
                    themeIcon.classList.add('bi-sun-fill');
                }
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            const themeIcon = document.getElementById('themeIcon');
            
            // Update Icon
            if (isDark) {
                themeIcon.classList.remove('bi-moon-fill');
                themeIcon.classList.add('bi-sun-fill');
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.classList.remove('bi-sun-fill');
                themeIcon.classList.add('bi-moon-fill');
                localStorage.setItem('theme', 'light');
            }
            // Update chart colors if theme changes
            renderCharts();
        }

        // --- Core Functions ---

        function loadProducts() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        products = parsed; 
                    }
                } else {
                    saveProducts();
                }
            } catch(e) {
                console.warn("LocalStorage error", e);
            }
            
            renderProducts();
            updateStats();
            renderCharts(); // Load charts
        }

        function saveProducts() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
            } catch(e) {
                console.warn("Could not save to localStorage", e);
            }
            updateStats();
            renderProducts();
            renderCharts(); // Update charts on save
        }

        function loadSales() {
            try {
                const stored = localStorage.getItem(SALES_STORAGE_KEY);
                if (stored) {
                    sales = JSON.parse(stored);
                }
            } catch(e) {
                console.warn("Sales storage error", e);
            }
        }

        function saveSales() {
            try {
                localStorage.setItem(SALES_STORAGE_KEY, JSON.stringify(sales));
            } catch(e) {
                console.warn("Could not save sales", e);
            }
            renderSalesHistory();
        }

        // --- Chart Logic ---
        let categoryChartInstance = null;

        function renderCharts() {
            const ctx = document.getElementById('categoryChart');
            if(!ctx) return;

            // Calculate Counts
            const counts = {};
            products.forEach(p => {
                const cat = p.category || 'Uncategorized';
                counts[cat] = (counts[cat] || 0) + 1;
            });

            // Update Summary Stats
            const totalStockVal = document.getElementById('totalStockValue');
            const mostStocked = document.getElementById('mostStocked');
            
            if(totalStockVal) totalStockVal.textContent = Object.keys(counts).length;
            
            if(mostStocked) {
                let maxCat = '-';
                let maxVal = 0;
                for(const [cat, val] of Object.entries(counts)) {
                    if(val > maxVal) { maxVal = val; maxCat = cat; }
                }
                mostStocked.textContent = maxCat;
            }

            // Destroy existing
            if(categoryChartInstance) {
                categoryChartInstance.destroy();
            }

            // Theme Colors
            const isDark = document.body.classList.contains('dark-mode');
            const textColor = isDark ? '#e2e8f0' : '#2d3748';
            const borderColor = isDark ? '#1e293b' : '#ffffff';

            categoryChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        data: Object.values(counts),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#2af598', '#009efd', 
                            '#f59e0b', '#ef4444', '#ec4899', '#6366f1'
                        ],
                        borderWidth: 2,
                        borderColor: borderColor
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: textColor,
                                font: { family: 'Inter', size: 11 }
                            }
                        }
                    }
                }
            });
        }

        // --- Export CSV Function ---
        function exportToCSV() {
            if (!products || products.length === 0) {
                showToast('No products to export', 'error');
                return;
            }

            // Define CSV Headers
            const headers = ['ID', 'Title', 'Category', 'Price', 'Sale Price', 'Stock', 'SKU', 'Brand', 'Supplier', 'Description'];
            
            // Map Data to CSV Format
            const csvRows = [headers.join(',')];
            
            products.forEach(p => {
                const row = [
                    p.id,
                    `"${(p.title || '').replace(/"/g, '""')}"`, // Escape quotes
                    `"${(p.category || '').replace(/"/g, '""')}"`,
                    p.price,
                    p.salePrice || '',
                    p.stock,
                    `"${(p.sku || '').replace(/"/g, '""')}"`,
                    `"${(p.brand || '').replace(/"/g, '""')}"`,
                    `"${(p.supplier || '').replace(/"/g, '""')}"`,
                    `"${(p.description || '').replace(/"/g, '""')}"`
                ];
                csvRows.push(row.join(','));
            });

            // Create File and Trigger Download
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `products_export_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast('Product catalog exported successfully', 'success');
        }

        // --- Toast Functions ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `custom-toast ${type}`;
            const icon = type === 'success' ? 'check-circle-fill text-success' : 'x-circle-fill text-danger';
            
            toast.innerHTML = `
                <i class="bi bi-${icon} fs-5"></i>
                <div>
                    <div class="fw-bold" style="font-size: 0.9rem;">${type === 'success' ? 'Success' : 'Error'}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">${message}</div>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Remove after 3s
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        // --- Render Logic ---

        function renderProducts(filterText = '') {
            const cardContainer = document.getElementById('cardContainer');
            const tableBody = document.getElementById('productTableBody');
            const emptyState = document.getElementById('emptyState');
            const sortSelect = document.getElementById('sortSelect');
            const paginationContainer = document.getElementById('paginationContainer');
            
            if (!cardContainer || !tableBody || !emptyState) return;

            cardContainer.innerHTML = '';
            tableBody.innerHTML = '';

            let filteredProducts = products.filter(p => 
                p.title.toLowerCase().includes(filterText.toLowerCase()) || 
                p.category.toLowerCase().includes(filterText.toLowerCase())
            );

            // Sorting Logic
            if(sortSelect) {
                const sortValue = sortSelect.value;
                filteredProducts.sort((a, b) => {
                    const priceA = a.salePrice ? parseFloat(a.salePrice) : parseFloat(a.price);
                    const priceB = b.salePrice ? parseFloat(b.salePrice) : parseFloat(b.price);

                    if (sortValue === 'price_asc') {
                        return priceA - priceB;
                    } else if (sortValue === 'price_desc') {
                        return priceB - priceA;
                    } else {
                        // Default: name_asc
                        return a.title.localeCompare(b.title);
                    }
                });
            }

            if (filteredProducts.length === 0) {
                emptyState.classList.remove('d-none');
                paginationContainer.classList.add('d-none');
                return;
            } else {
                emptyState.classList.add('d-none');
                paginationContainer.classList.remove('d-none');
            }

            // --- Pagination Logic ---
            const totalItems = filteredProducts.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            
            // Ensure currentPage is valid
            if (currentPage > totalPages) currentPage = 1;
            if (currentPage < 1) currentPage = 1;

            // Slice items for current page
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const paginatedItems = filteredProducts.slice(startIndex, endIndex);

            // Render Items
            paginatedItems.forEach(product => {
                // Calculation Logic for Display
                const hasSale = product.salePrice && parseFloat(product.salePrice) < parseFloat(product.price);
                const currentPrice = hasSale ? parseFloat(product.salePrice) : parseFloat(product.price);
                
                const priceDisplay = hasSale 
                    ? `<span class="text-decoration-line-through text-secondary me-2 small">$${parseFloat(product.price).toFixed(2)}</span>
                       <span class="product-price-sale">$${parseFloat(product.salePrice).toFixed(2)}</span>`
                    : `<span class="product-price">$${parseFloat(product.price).toFixed(2)}</span>`;

                const discountBadge = hasSale
                    ? `<div class="position-absolute top-0 start-0 m-2 badge bg-danger shadow-sm">
                         -${Math.round(((product.price - product.salePrice) / product.price) * 100)}%
                       </div>`
                    : '';

                // 1. Render Card
                const cardCol = document.createElement('div');
                cardCol.className = 'col-md-6 col-lg-4 col-xl-3';
                cardCol.innerHTML = `
                    <div class="product-card">
                        <div class="product-img-wrapper">
                            ${discountBadge}
                            <img src="${product.image || 'https://via.placeholder.com/300x200?text=No+Image'}" 
                                 class="product-img" 
                                 onerror="this.src='https://via.placeholder.com/300x200?text=Error'" 
                                 alt="${product.title}">
                            <div class="card-actions">
                                <button class="action-btn sell" onclick="openSellModal(${product.id})" title="Sell Product">
                                    <i class="bi bi-cart-check"></i>
                                </button>
                                <button class="action-btn edit" onclick="editProduct(${product.id})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="action-btn delete" onclick="deleteProduct(${product.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="product-details">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <span class="product-category">${product.category}</span>
                                <span class="product-category text-end" style="color: #764ba2;">${product.brand || ''}</span>
                            </div>
                            <h5 class="product-title" title="${product.title}">${product.title}</h5>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="d-flex align-items-center">
                                    ${priceDisplay}
                                </div>
                                ${getStockBadge(product.stock)}
                            </div>
                        </div>
                    </div>
                `;
                cardContainer.appendChild(cardCol);

                // 2. Render Table Row
                const tr = document.createElement('tr');
                
                // --- LOW STOCK ALERT LOGIC ---
                const stockLevel = parseInt(product.stock);
                if (stockLevel === 0) {
                    tr.classList.add('row-out-stock');
                } else if (stockLevel < 5) {
                    tr.classList.add('row-low-stock');
                }

                tr.innerHTML = `
                    <td>
                        <img src="${product.image || 'https://via.placeholder.com/50?text=Img'}" 
                             class="table-img" 
                             onerror="this.src='https://via.placeholder.com/50?text=Error'">
                    </td>
                    <td>
                        <div class="fw-bold" style="color: var(--text-primary)">${product.title}</div>
                        <small class="text-muted d-block">Brand: ${product.brand || 'N/A'}</small>
                        <small style="color: var(--text-secondary)">SKU: ${product.sku}</small>
                    </td>
                    <td><span class="badge bg-light text-dark border">${product.category}</span></td>
                    <td>${priceDisplay}</td>
                    <td>${getStockBadge(product.stock)}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-success me-1" onclick="openSellModal(${product.id})" title="Sell">
                            <i class="bi bi-cart-check"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct(${product.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });

            // Render Pagination Controls
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            const paginationControls = document.getElementById('paginationControls');
            paginationControls.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous Button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" onclick="changePage(${currentPage - 1})"><i class="bi bi-chevron-left"></i></a>`;
            paginationControls.appendChild(prevLi);

            // Page Numbers
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${currentPage === i ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" onclick="changePage(${i})">${i}</a>`;
                paginationControls.appendChild(li);
            }

            // Next Button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" onclick="changePage(${currentPage + 1})"><i class="bi bi-chevron-right"></i></a>`;
            paginationControls.appendChild(nextLi);
        }

        function changePage(page) {
            currentPage = page;
            const searchValue = document.getElementById('searchInput').value;
            renderProducts(searchValue);
        }

        function getStockBadge(stock) {
            stock = parseInt(stock);
            if (stock === 0) return '<span class="stock-badge bg-stock-red">Out of Stock</span>';
            if (stock < 10) return '<span class="stock-badge bg-stock-orange">Low: ' + stock + '</span>';
            return '<span class="stock-badge bg-stock-green">In Stock: ' + stock + '</span>';
        }

        function updateStats() {
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('inStock').textContent = products.filter(p => parseInt(p.stock) >= 10).length;
            document.getElementById('lowStock').textContent = products.filter(p => parseInt(p.stock) > 0 && parseInt(p.stock) < 10).length;
            document.getElementById('outOfStock').textContent = products.filter(p => parseInt(p.stock) === 0).length;
        }

        // --- Sales History Logic ---
        function renderSalesHistory() {
            const tableBody = document.getElementById('salesTableBody');
            const emptyState = document.getElementById('salesEmptyState');
            
            if(!sales || sales.length === 0) {
                tableBody.innerHTML = '';
                emptyState.classList.remove('d-none');
                document.getElementById('totalRevenue').textContent = '$0.00';
                document.getElementById('totalItemsSold').textContent = '0';
                return;
            }

            emptyState.classList.add('d-none');
            tableBody.innerHTML = '';
            
            // Sort by date (newest first)
            const sortedSales = [...sales].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let totalRev = 0;
            let totalItems = 0;

            sortedSales.forEach(sale => {
                totalRev += sale.total;
                totalItems += parseInt(sale.quantity);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(sale.date).toLocaleDateString()} <small class="text-muted">${new Date(sale.date).toLocaleTimeString()}</small></td>
                    <td class="fw-bold" style="color: var(--text-primary)">${sale.productName}</td>
                    <td class="text-muted small">${sale.productSku || '-'}</td>
                    <td>${sale.quantity}</td>
                    <td class="fw-bold text-success">$${sale.total.toFixed(2)}</td>
                `;
                tableBody.appendChild(tr);
            });

            document.getElementById('totalRevenue').textContent = `$${totalRev.toFixed(2)}`;
            document.getElementById('totalItemsSold').textContent = totalItems;
        }

        // --- Sell Logic ---
        function openSellModal(id) {
            const product = products.find(p => String(p.id) === String(id));
            if (!product) return;

            // Populate Modal
            document.getElementById('sellProductId').value = product.id;
            document.getElementById('sellProductName').textContent = product.title;
            document.getElementById('sellProductSku').textContent = `SKU: ${product.sku}`;
            document.getElementById('sellCurrentStock').textContent = product.stock;
            
            // Determine active price
            const activePrice = (product.salePrice && parseFloat(product.salePrice) < parseFloat(product.price)) 
                ? parseFloat(product.salePrice) 
                : parseFloat(product.price);
            
            document.getElementById('sellUnitPrice').textContent = `$${activePrice.toFixed(2)}`;
            
            // Reset Input
            const qtyInput = document.getElementById('sellQuantity');
            qtyInput.value = 1;
            qtyInput.max = product.stock; // Set max attribute
            
            // Calc initial total
            calculateSellTotal(activePrice);

            // Add event listener for dynamic total calc
            qtyInput.oninput = function() {
                const qty = parseInt(this.value);
                const stock = parseInt(product.stock);
                const errDiv = document.getElementById('sellStockError');
                
                if (qty > stock) {
                    errDiv.classList.remove('d-none');
                    document.getElementById('sellTotal').textContent = "$0.00";
                } else {
                    errDiv.classList.add('d-none');
                    const total = qty * activePrice;
                    document.getElementById('sellTotal').textContent = `$${total.toFixed(2)}`;
                }
            };

            new bootstrap.Modal(document.getElementById('sellModal')).show();
        }

        function calculateSellTotal(price) {
            const qty = parseInt(document.getElementById('sellQuantity').value) || 0;
            const total = qty * price;
            document.getElementById('sellTotal').textContent = `$${total.toFixed(2)}`;
        }

        // Handle Sell Submit
        const sellForm = document.getElementById('sellForm');
        if(sellForm) {
            sellForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const productId = document.getElementById('sellProductId').value;
                const qty = parseInt(document.getElementById('sellQuantity').value);
                
                // Find Product
                const productIndex = products.findIndex(p => String(p.id) === String(productId));
                if (productIndex === -1) return;
                
                const product = products[productIndex];
                
                // Validate Stock
                if (qty > parseInt(product.stock)) {
                    showToast('Insufficient stock!', 'error');
                    return;
                }

                // Calculate Total
                const activePrice = (product.salePrice && parseFloat(product.salePrice) < parseFloat(product.price)) 
                    ? parseFloat(product.salePrice) 
                    : parseFloat(product.price);
                const total = qty * activePrice;

                // 1. Update Product Stock
                products[productIndex].stock = parseInt(product.stock) - qty;
                
                // 2. Create Sale Record
                const saleRecord = {
                    id: Date.now(),
                    productId: product.id,
                    productName: product.title,
                    productSku: product.sku,
                    quantity: qty,
                    total: total,
                    date: new Date().toISOString()
                };
                
                sales.push(saleRecord);

                // 3. Save Everything
                saveProducts(); // Updates inventory
                saveSales();    // Updates sales history

                // 4. UI Feedback
                showToast('Sale completed successfully!', 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('sellModal'));
                modal.hide();
            });
        }

        // --- Event Listeners ---

        function setupEventListeners() {
            // View Toggles
            document.getElementById('cardView').addEventListener('change', () => {
                document.getElementById('cardContainer').classList.remove('d-none');
                document.getElementById('tableContainer').classList.add('d-none');
            });
            
            document.getElementById('tableView').addEventListener('change', () => {
                document.getElementById('cardContainer').classList.add('d-none');
                document.getElementById('tableContainer').classList.remove('d-none');
            });

            // Search
            const searchInput = document.getElementById('searchInput');
            if(searchInput) {
                searchInput.addEventListener('input', (e) => {
                    currentPage = 1; // Reset to page 1 on search
                    renderProducts(e.target.value);
                });
            }

            // Sort Dropdown
            const sortSelect = document.getElementById('sortSelect');
            if(sortSelect) {
                sortSelect.addEventListener('change', () => {
                    currentPage = 1; // Reset to page 1 on sort
                    const searchValue = document.getElementById('searchInput').value;
                    renderProducts(searchValue);
                });
            }

            // Image Preview
            const imgInput = document.getElementById('productImage');
            if(imgInput) {
                imgInput.addEventListener('input', (e) => {
                    const url = e.target.value;
                    const container = document.getElementById('imagePreviewContainer');
                    const img = document.getElementById('imagePreview');
                    if (url) {
                        container.classList.remove('d-none');
                        img.src = url;
                        img.onerror = () => { container.classList.add('d-none'); };
                    } else {
                        container.classList.add('d-none');
                    }
                });
            }

            // Discount Calculation Inputs
            const priceIn = document.getElementById('productPrice');
            const saleIn = document.getElementById('productSalePrice');
            if(priceIn && saleIn) {
                const calc = () => {
                    const p = parseFloat(priceIn.value);
                    const s = parseFloat(saleIn.value);
                    const disc = document.getElementById('productDiscount');
                    
                    if(p && s && s < p) {
                        const pct = Math.round(((p-s)/p)*100);
                        disc.value = `${pct}% OFF`;
                        disc.style.color = '#10b981';
                    } else {
                        disc.value = '';
                    }
                };
                priceIn.addEventListener('input', calc);
                saleIn.addEventListener('input', calc);
            }

            // Form Submit
            const form = document.getElementById('productForm');
            if(form) {
                form.addEventListener('submit', handleFormSubmit);
            }
            
            // Delete Confirm
            const deleteBtn = document.getElementById('confirmDeleteBtn');
            if(deleteBtn) {
                deleteBtn.addEventListener('click', confirmDeleteAction);
            }
        }

        // --- Actions ---

        function openAddModal() {
            document.getElementById('productForm').reset();
            document.getElementById('editProductId').value = ""; 
            document.getElementById('imagePreviewContainer').classList.add('d-none');
            document.getElementById('productDiscount').value = "";
            document.getElementById('productModalLabel').textContent = "Add New Product";
            
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }

        function editProduct(id) {
            const product = products.find(p => String(p.id) === String(id));
            if (!product) return;

            document.getElementById('productTitle').value = product.title;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productSalePrice').value = product.salePrice || '';
            document.getElementById('productCategory').value = product.category;
            // Load description
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productImage').value = product.image;
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productSku').value = product.sku;
            // Load Brand and Supplier
            document.getElementById('productBrand').value = product.brand || '';
            document.getElementById('productSupplier').value = product.supplier || '';

            // Trigger discount calc
            const p = parseFloat(product.price);
            const s = parseFloat(product.salePrice);
            if(p && s && s < p) {
                document.getElementById('productDiscount').value = `${Math.round(((p-s)/p)*100)}% OFF`;
            } else {
                document.getElementById('productDiscount').value = "";
            }

            if(product.image) {
                document.getElementById('imagePreview').src = product.image;
                document.getElementById('imagePreviewContainer').classList.remove('d-none');
            } else {
                document.getElementById('imagePreviewContainer').classList.add('d-none');
            }

            document.getElementById('editProductId').value = product.id;
            
            document.getElementById('productModalLabel').textContent = "Edit Product";
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            
            const title = document.getElementById('productTitle').value;
            const price = document.getElementById('productPrice').value;
            const salePrice = document.getElementById('productSalePrice').value;
            const category = document.getElementById('productCategory').value;
            const description = document.getElementById('productDescription').value; 
            const image = document.getElementById('productImage').value;
            const stock = document.getElementById('productStock').value;
            let sku = document.getElementById('productSku').value;
            const brand = document.getElementById('productBrand').value;
            const supplier = document.getElementById('productSupplier').value;
            const editId = document.getElementById('editProductId').value; 

            if (!sku) sku = 'SKU-' + Date.now().toString().slice(-6);

            if (editId) {
                const index = products.findIndex(p => String(p.id) === String(editId));
                if (index !== -1) {
                    products[index] = {
                        id: parseInt(editId), 
                        title, price, salePrice, category, description, image, stock, sku, brand, supplier
                    };
                    showToast('Product updated successfully', 'success');
                }
            } else {
                const newProduct = {
                    id: Date.now(),
                    title, price, salePrice, category, description, image, stock, sku, brand, supplier
                };
                products.push(newProduct);
                showToast('Product added successfully', 'success');
            }

            saveProducts();
            
            const modalEl = document.getElementById('productModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
        }

        let productToDeleteId = null;

        function deleteProduct(id) {
            productToDeleteId = id;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }
        
        function confirmDeleteAction() {
            if(productToDeleteId) {
                products = products.filter(p => String(p.id) !== String(productToDeleteId));
                saveProducts();
                showToast('Product deleted successfully', 'success');
                
                const modalEl = document.getElementById('deleteModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                
                productToDeleteId = null;
            }
        }
    </script>
</body>
</html>